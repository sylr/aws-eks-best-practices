
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-7.1.2">
    
    
      
        <title>Control Plane - EKS Best Practices Guides</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.6f955dcd.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.ef6f36e2.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style>
      
    
    
    
    
      
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    <script>function __prefix(e){return new URL("../../..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#eks-control-plane" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="EKS Best Practices Guides" class="md-header__button md-logo" aria-label="EKS Best Practices Guides" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            EKS Best Practices Guides
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Control Plane
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        
<a href="https://github.com/aws/aws-eks-best-practices/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    aws/aws-eks-best-practices
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="EKS Best Practices Guides" class="md-nav__button md-logo" aria-label="EKS Best Practices Guides" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    EKS Best Practices Guides
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/aws/aws-eks-best-practices/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    aws/aws-eks-best-practices
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_1" type="checkbox" id="__nav_1" >
      
      <label class="md-nav__link" for="__nav_1">
        Guides
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Guides" data-md-level="1">
        <label class="md-nav__title" for="__nav_1">
          <span class="md-nav__icon md-icon"></span>
          Guides
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        Introduction
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      <label class="md-nav__link" for="__nav_2">
        Security
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Security" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Security
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../security/docs/" class="md-nav__link">
        Home
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../security/docs/iam/" class="md-nav__link">
        Identity and Access Management
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../security/docs/pods/" class="md-nav__link">
        Pod Security
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../security/docs/multitenancy/" class="md-nav__link">
        Multi-tenancy
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../security/docs/detective/" class="md-nav__link">
        Detective Controls
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../security/docs/network/" class="md-nav__link">
        Network Security
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../security/docs/data/" class="md-nav__link">
        Data Encryption and Secrets Management
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../security/docs/runtime/" class="md-nav__link">
        Runtime Security
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../security/docs/hosts/" class="md-nav__link">
        Infrastructure Security
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../security/docs/compliance/" class="md-nav__link">
        Regulatory Compliance
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../security/docs/incidents/" class="md-nav__link">
        Incident Response and Forensics
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../security/docs/image/" class="md-nav__link">
        Image Security
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      <label class="md-nav__link" for="__nav_3">
        Cluster Autoscaling
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Cluster Autoscaling" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Cluster Autoscaling
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../cluster-autoscaling/cluster-autoscaling/" class="md-nav__link">
        Home
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" checked>
      
      <label class="md-nav__link" for="__nav_4">
        Reliability
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Reliability" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Reliability
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        Home
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../application/" class="md-nav__link">
        Applications
      </a>
    </li>
  

          
            
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Control Plane
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Control Plane
      </a>
      
        
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#eks-architecture" class="md-nav__link">
    EKS Architecture
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#recommendations" class="md-nav__link">
    Recommendations
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#monitor-control-plane-metrics" class="md-nav__link">
    Monitor Control Plane Metrics
  </a>
  
    <nav class="md-nav" aria-label="Monitor Control Plane Metrics">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#api-server" class="md-nav__link">
    API Server
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#etcd" class="md-nav__link">
    etcd
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cluster-authentication" class="md-nav__link">
    Cluster Authentication
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#handling-cluster-upgrades" class="md-nav__link">
    Handling Cluster Upgrades
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#running-large-clusters" class="md-nav__link">
    Running large clusters
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#know-limits-and-service-quotas" class="md-nav__link">
    Know limits and service quotas
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#additional-resources" class="md-nav__link">
    Additional Resources:
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../dataplane/" class="md-nav__link">
        Data Plane
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../networkmanagement/" class="md-nav__link">
        Network
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#eks-architecture" class="md-nav__link">
    EKS Architecture
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#recommendations" class="md-nav__link">
    Recommendations
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#monitor-control-plane-metrics" class="md-nav__link">
    Monitor Control Plane Metrics
  </a>
  
    <nav class="md-nav" aria-label="Monitor Control Plane Metrics">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#api-server" class="md-nav__link">
    API Server
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#etcd" class="md-nav__link">
    etcd
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cluster-authentication" class="md-nav__link">
    Cluster Authentication
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#handling-cluster-upgrades" class="md-nav__link">
    Handling Cluster Upgrades
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#running-large-clusters" class="md-nav__link">
    Running large clusters
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#know-limits-and-service-quotas" class="md-nav__link">
    Know limits and service quotas
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#additional-resources" class="md-nav__link">
    Additional Resources:
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/aws/aws-eks-best-practices/edit/master/docs/reliability/docs/controlplane.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                <h1 id="eks-control-plane">EKS Control Plane<a class="headerlink" href="#eks-control-plane" title="Permanent link">&para;</a></h1>
<p>Amazon Elastic Kubernetes Service (EKS) is a managed Kubernetes service that makes it easy for you to run Kubernetes on AWS without needing to install, operate, and maintain your own Kubernetes control plane or worker nodes. It runs upstream Kubernetes and is certified Kubernetes conformant. This conformance ensures that EKS supports the Kubernetes APIs, just like the open-source community version that you can install on EC2 or on-premises. Existing applications running on upstream Kubernetes are compatible with Amazon EKS.</p>
<p>EKS automatically manages the availability and scalability of the Kubernetes control plane nodes, and it automatically replaces unhealthy control plane nodes.</p>
<h2 id="eks-architecture">EKS Architecture<a class="headerlink" href="#eks-architecture" title="Permanent link">&para;</a></h2>
<p>EKS architecture is designed to eliminate any single points of failure that may compromise the availability and durability of the Kubernetes control plane.</p>
<p>The Kubernetes control plane managed by EKS runs inside an EKS managed VPC. The EKS control plane comprises the Kubernetes API server nodes, etcd cluster. Kubernetes API server nodes that run components like the API server, scheduler, and <code>kube-controller-manager</code> run in an auto-scaling group. EKS runs a minimum of two API server nodes in distinct Availability Zones (AZs) within in AWS region. Likewise, for durability, the etcd server nodes also run in an auto-scaling group that spans three AZs. EKS runs a NAT Gateway in each AZ, and API servers and etcd servers run in a private subnet. This architecture ensures that an event in a single AZ doesn’t affect the EKS cluster's availability.  </p>
<p>When you create a new cluster, Amazon EKS creates a highly-available endpoint for the managed Kubernetes API server that you use to communicate with your cluster (using tools like <code>kubectl</code>). The managed endpoint uses NLB to load balance Kubernetes API servers. EKS also provisions two <a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/using-eni.html">ENI</a>s in different AZs to facilitate communication to your worker nodes.</p>
<p><img alt="EKS Data plane network connectivity" src="../images/eks-data-plane-connectivity.jpeg" /></p>
<p>You can <a href="https://docs.aws.amazon.com/eks/latest/userguide/cluster-endpoint.html">configure whether your Kubernetes cluster’s API server</a> is reachable from the public internet (using the public endpoint) or through your VPC (using the EKS-managed ENIs) or both.  </p>
<p>Whether users and worker nodes connect to the API server using the public endpoint or the EKS-managed ENI, there are redundant paths for connection. </p>
<h2 id="recommendations">Recommendations<a class="headerlink" href="#recommendations" title="Permanent link">&para;</a></h2>
<h2 id="monitor-control-plane-metrics">Monitor Control Plane Metrics<a class="headerlink" href="#monitor-control-plane-metrics" title="Permanent link">&para;</a></h2>
<p>Monitoring Kubernetes API metrics can give you insights into control plane performance and identify issues. An unhealthy control plane can compromise the availability of the workloads running inside the cluster. For example, poorly written controllers can overload the API servers, affecting your application's availability. </p>
<p>Kubernetes exposes control plane metrics at the  <code>/metrics</code> endpoint. </p>
<p>You can view the metrics exposed using <code>kubectl</code>:</p>
<div class="codehilite"><pre><span></span><code>kubectl get --raw /metrics
</code></pre></div>

<p>These metrics are represented in a <a href="https://github.com/prometheus/docs/blob/master/content/docs/instrumenting/exposition_formats.md">Prometheus text format</a>. </p>
<p>You can use Prometheus to collect and store these metrics. In May 2020, CloudWatch added support for monitoring Prometheus metrics in CloudWatch Container Insights. So you can also use Amazon CloudWatch to monitor the EKS control plane. You can use <a href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/ContainerInsights-Prometheus-Setup-configure.html#ContainerInsights-Prometheus-Setup-new-exporters">Tutorial for Adding a New Prometheus Scrape Target: Prometheus KPI Server Metrics</a> to collect metrics and create CloudWatch dashboard to monitor your cluster’s control plane.</p>
<p>You can find Kubernetes API server metrics  <a href="https://github.com/kubernetes/apiserver/blob/master/pkg/endpoints/metrics/metrics.go">here</a>. For example, <code>apiserver_request_duration_seconds</code> can indicate how long API requests are taking to run. </p>
<p>Consider monitoring these control plane metrics:</p>
<h3 id="api-server">API Server<a class="headerlink" href="#api-server" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th align="left">Metric</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left"><code>apiserver_request_total</code></td>
<td align="left">Counter of apiserver requests broken out for each verb, dry run value, group, version, resource, scope, component, client, and HTTP response contentType and code.</td>
</tr>
<tr>
<td align="left"><code>apiserver_request_duration_seconds*</code></td>
<td align="left">Response latency distribution in seconds for each verb, dry run value, group, version, resource, subresource, scope, and component.</td>
</tr>
<tr>
<td align="left"><code>rest_client_request_duration_seconds</code></td>
<td align="left">Request latency in seconds. Broken down by verb and URL.</td>
</tr>
<tr>
<td align="left"><code>apiserver_admission_controller_admission_duration_seconds</code></td>
<td align="left">Admission controller latency histogram in seconds, identified by name and broken out for each operation and API resource and type (validate or admit).</td>
</tr>
<tr>
<td align="left"><code>rest_client_request_duration_seconds</code></td>
<td align="left">Request latency in seconds. Broken down by verb and URL.</td>
</tr>
<tr>
<td align="left"><code>rest_client_requests_total</code></td>
<td align="left">Number of HTTP requests, partitioned by status code, method, and host.</td>
</tr>
</tbody>
</table>
<h3 id="etcd">etcd<a class="headerlink" href="#etcd" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th align="left">Metric</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left"><code>etcd_request_duration_seconds</code></td>
<td align="left">Etcd request latency in seconds for each operation and object type.</td>
</tr>
</tbody>
</table>
<p>Consider using <a href="https://grafana.com/grafana/dashboards/12006">Grafana dashboard 12006</a> to visualize and monitor Kubernetes API server requests and latency and etcd latency metrics. </p>
<h2 id="cluster-authentication">Cluster Authentication<a class="headerlink" href="#cluster-authentication" title="Permanent link">&para;</a></h2>
<p>EKS currently supports two types of authentication: <a href="https://kubernetes.io/docs/reference/access-authn-authz/authentication/#service-account-tokens">bearer/service account tokens</a> and IAM authentication which uses <a href="https://kubernetes.io/docs/reference/access-authn-authz/authentication/#webhook-token-authentication">webhook token authentication</a>. When users call the Kubernetes API, a webhook passes an authentication token included in the request to IAM. The token, a base 64 signed URL, is generated by the AWS Command Line Interface (<a href="https://aws.amazon.com/cli/">AWS CLI</a>). </p>
<p>The IAM user or role that creates the EKS Cluster automatically gets full access to the cluster. You can manage access to the EKS cluster by editing the <a href="https://docs.aws.amazon.com/eks/latest/userguide/add-user-role.html"><code>aws-auth</code> configmap</a>. </p>
<p>If you misconfigure the <code>aws-auth</code> configmap and lose access to the cluster, you can still use the cluster creator’s user or role to access your EKS cluster. </p>
<p>In the unlikely event that you cannot use the IAM service in the AWS region, you can also use the Kubernetes service account’s bearer token to manage the cluster. </p>
<p>Create a “super-admin” account that is permitted to perform all actions in the cluster:</p>
<div class="codehilite"><pre><span></span><code>kubectl -n kube-system create serviceaccount super-admin
</code></pre></div>

<p>Create a role binding that gives super-admin cluster-admin role:</p>
<div class="codehilite"><pre><span></span><code>kubectl create clusterrolebinding super-admin-rb --clusterrole=cluster-admin --serviceaccount=kube-system:super-admin
</code></pre></div>

<p>Get service account’s secret:</p>
<div class="codehilite"><pre><span></span><code>SECRET_NAME=`kubectl -n kube-system get serviceaccount/super-admin -o jsonpath=&#39;{.secrets[0].name}&#39;`
</code></pre></div>

<p>Get token associated with the secret:</p>
<div class="codehilite"><pre><span></span><code>TOKEN=`kubectl -n kube-system get secret $SECRET_NAME -o jsonpath=&#39;{.data.token}&#39;| base64 --decode`
</code></pre></div>

<p>Add service account and token to <code>kubeconfig</code>:</p>
<div class="codehilite"><pre><span></span><code>kubectl config set-credentials super-admin --token=$TOKEN
</code></pre></div>

<p>Set the current-context in <code>kubeconfig</code> to use super-admin account:</p>
<div class="codehilite"><pre><span></span><code>kubectl config set-context --current --user=super-admin
</code></pre></div>

<p>Final <code>kubeconfig</code> should look like this:</p>
<div class="codehilite"><pre><span></span><code><span class="n">apiVersion</span><span class="o">:</span> <span class="n">v1</span>
<span class="n">clusters</span><span class="o">:</span>
<span class="o">-</span> <span class="n">cluster</span><span class="o">:</span>
    <span class="n">certificate</span><span class="o">-</span><span class="n">authority</span><span class="o">-</span><span class="n">data</span><span class="o">:&lt;</span><span class="n">REDACTED</span><span class="o">&gt;</span>
    <span class="n">server</span><span class="o">:</span> <span class="n">https</span><span class="o">://&lt;</span><span class="n">CLUSTER</span><span class="o">&gt;.</span><span class="n">gr7</span><span class="o">.</span><span class="na">us</span><span class="o">-</span><span class="n">west</span><span class="o">-</span><span class="mi">2</span><span class="o">.</span><span class="na">eks</span><span class="o">.</span><span class="na">amazonaws</span><span class="o">.</span><span class="na">com</span>
  <span class="n">name</span><span class="o">:</span> <span class="n">arn</span><span class="o">:</span><span class="n">aws</span><span class="o">:</span><span class="n">eks</span><span class="o">:</span><span class="n">us</span><span class="o">-</span><span class="n">west</span><span class="o">-</span><span class="mi">2</span><span class="o">:&lt;</span><span class="n">account</span> <span class="n">number</span><span class="o">&gt;:</span><span class="n">cluster</span><span class="o">/&lt;</span><span class="n">cluster</span> <span class="n">name</span><span class="o">&gt;</span>
<span class="n">contexts</span><span class="o">:</span>
<span class="o">-</span> <span class="n">context</span><span class="o">:</span>
    <span class="n">cluster</span><span class="o">:</span> <span class="n">arn</span><span class="o">:</span><span class="n">aws</span><span class="o">:</span><span class="n">eks</span><span class="o">:</span><span class="n">us</span><span class="o">-</span><span class="n">west</span><span class="o">-</span><span class="mi">2</span><span class="o">:&lt;</span><span class="n">account</span> <span class="n">number</span><span class="o">&gt;:</span><span class="n">cluster</span><span class="o">/&lt;</span><span class="n">cluster</span> <span class="n">name</span><span class="o">&gt;</span>
    <span class="n">user</span><span class="o">:</span> <span class="kd">super</span><span class="o">-</span><span class="n">admin</span>
  <span class="n">name</span><span class="o">:</span> <span class="n">arn</span><span class="o">:</span><span class="n">aws</span><span class="o">:</span><span class="n">eks</span><span class="o">:</span><span class="n">us</span><span class="o">-</span><span class="n">west</span><span class="o">-</span><span class="mi">2</span><span class="o">:&lt;</span><span class="n">account</span> <span class="n">number</span><span class="o">&gt;:</span><span class="n">cluster</span><span class="o">/&lt;</span><span class="n">cluster</span> <span class="n">name</span><span class="o">&gt;</span>
<span class="n">current</span><span class="o">-</span><span class="n">context</span><span class="o">:</span> <span class="n">arn</span><span class="o">:</span><span class="n">aws</span><span class="o">:</span><span class="n">eks</span><span class="o">:</span><span class="n">us</span><span class="o">-</span><span class="n">west</span><span class="o">-</span><span class="mi">2</span><span class="o">:&lt;</span><span class="n">account</span> <span class="n">number</span><span class="o">&gt;:</span><span class="n">cluster</span><span class="o">/&lt;</span><span class="n">cluster</span> <span class="n">name</span><span class="o">&gt;</span>
<span class="n">kind</span><span class="o">:</span> <span class="n">Config</span>
<span class="n">preferences</span><span class="o">:</span> <span class="o">{}</span>
<span class="n">users</span><span class="o">:</span>
<span class="err">#</span><span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">arn</span><span class="o">:</span><span class="n">aws</span><span class="o">:</span><span class="n">eks</span><span class="o">:</span><span class="n">us</span><span class="o">-</span><span class="n">west</span><span class="o">-</span><span class="mi">2</span><span class="o">:&lt;</span><span class="n">account</span> <span class="n">number</span><span class="o">&gt;:</span><span class="n">cluster</span><span class="o">/&lt;</span><span class="n">cluster</span> <span class="n">name</span><span class="o">&gt;</span>
<span class="err">#</span>  <span class="n">user</span><span class="o">:</span>
<span class="err">#</span>    <span class="n">exec</span><span class="o">:</span>
<span class="err">#</span>      <span class="n">apiVersion</span><span class="o">:</span> <span class="n">client</span><span class="o">.</span><span class="na">authentication</span><span class="o">.</span><span class="na">k8s</span><span class="o">.</span><span class="na">io</span><span class="o">/</span><span class="n">v1alpha1</span>
<span class="err">#</span>      <span class="n">args</span><span class="o">:</span>
<span class="err">#</span>      <span class="o">-</span> <span class="o">--</span><span class="n">region</span>
<span class="err">#</span>      <span class="o">-</span> <span class="n">us</span><span class="o">-</span><span class="n">west</span><span class="o">-</span><span class="mi">2</span>
<span class="err">#</span>      <span class="o">-</span> <span class="n">eks</span>
<span class="err">#</span>      <span class="o">-</span> <span class="kd">get</span><span class="o">-</span><span class="n">token</span>
<span class="err">#</span>      <span class="o">-</span> <span class="o">--</span><span class="n">cluster</span><span class="o">-</span><span class="n">name</span>
<span class="err">#</span>      <span class="o">-</span> <span class="o">&lt;&lt;</span><span class="n">cluster</span> <span class="n">name</span><span class="o">&gt;&gt;</span>
<span class="err">#</span>      <span class="n">command</span><span class="o">:</span> <span class="n">aws</span>
<span class="err">#</span>      <span class="n">env</span><span class="o">:</span> <span class="kc">null</span>
<span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="kd">super</span><span class="o">-</span><span class="n">admin</span>
  <span class="n">user</span><span class="o">:</span>
    <span class="n">token</span><span class="o">:</span> <span class="o">&lt;&lt;</span><span class="kd">super</span><span class="o">-</span><span class="n">admin</span> <span class="n">sa</span><span class="err">’</span><span class="n">s</span> <span class="n">secret</span><span class="o">&gt;&gt;</span>
</code></pre></div>

<h2 id="handling-cluster-upgrades">Handling Cluster Upgrades<a class="headerlink" href="#handling-cluster-upgrades" title="Permanent link">&para;</a></h2>
<p>Kubernetes follows a quarterly release cycle; a new minor version (like 1.<strong>16</strong> or 1.<strong>17</strong>) is released approximately every three months. Each minor version is supported for approximately nine months after it is first released. Kubernetes supports compatibility between the control plane and worker nodes for at least two minor versions.</p>
<p>In line with the Kubernetes community support for Kubernetes versions, EKS provides at least three production-ready versions of Kubernetes at any given time, with a fourth version in deprecation.</p>
<p>EKS will announce the deprecation of a given Kubernetes minor version at least 60 days before the end of support date. On the end of support date, clusters running the deprecated version will begin to be automatically updated to the next EKS-supported version of Kubernetes. </p>
<p>EKS performs in-place cluster upgrades for both <a href="https://docs.aws.amazon.com/eks/latest/userguide/kubernetes-versions.html">Kubernetes</a> and <a href="https://docs.aws.amazon.com/eks/latest/userguide/platform-versions.html">EKS platform versions</a>. This simplifies cluster operations and lets you take advantage of the latest Kubernetes features and apply security patches, without any downtime.</p>
<p>New Kubernetes versions introduce significant changes, and you cannot downgrade a cluster once upgraded. Having a well-documented process for handling cluster upgrades is necessary for a smooth transition to newer Kubernetes versions. You may consider migrating to new clusters when upgrading to newer Kubernetes versions instead of performing in-place cluster upgrades. Cluster backup and restore tools like <a href="https://github.com/vmware-tanzu/velero">VMware’s Velero</a> can help you migrate to a new cluster.  </p>
<ul>
<li>You should familiarize yourself with the <a href="https://kubernetes.io/docs/reference/using-api/deprecation-policy/">Kubernetes deprecation policy</a> as newer versions may deprecate APIs and features that may break existing applications. </li>
<li>Before upgrading the cluster, you should review the <a href="https://github.com/kubernetes/kubernetes/tree/master/CHANGELOG">Kubernetes change log</a> and <a href="https://docs.aws.amazon.com/eks/latest/userguide/kubernetes-versions.html">Amazon EKS Kubernetes versions</a> to understand any negative impact to your workloads. </li>
<li>Consider testing the cluster upgrade in a non-production environment and identify any impacts to current workloads and controllers. You can automate the testing by building a continuous integration workflow to test the compatibility of your applications, controllers, and custom integrations before moving to a new Kubernetes version.</li>
<li>You may also need to upgrade Kubernetes add-ons after upgrading the cluster. Review <a href="https://docs.aws.amazon.com/eks/latest/userguide/update-cluster.html">Updating an Amazon EKS cluster Kubernetes version</a> to validate the compatibility of cluster add-ons with the cluster version. </li>
<li>Consider turning on <a href="https://docs.aws.amazon.com/eks/latest/userguide/control-plane-logs.html">control plane logging</a> and review the logs for any errors. </li>
<li>Consider using <code>eksctl</code> to manage EKS cluster. You can use <code>eksctl</code> to <a href="https://eksctl.io/usage/cluster-upgrade/">update the control plane, add-ons, and worker nodes</a>. </li>
<li>EKS control plane upgrade doesn’t include upgrading worker nodes. You are responsible for updating EKS worker nodes. Consider using <a href="https://docs.aws.amazon.com/eks/latest/userguide/managed-node-groups.html">EKS managed node groups</a> or <a href="https://docs.aws.amazon.com/eks/latest/userguide/fargate.html">EKS on Fargate</a> to automate the process of upgrading worker nodes. </li>
<li>If required, you can use <code>kubectl convert</code> to <a href="https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands#convert">convert Kubernetes manifests files between different API versions</a>.</li>
</ul>
<h2 id="running-large-clusters">Running large clusters<a class="headerlink" href="#running-large-clusters" title="Permanent link">&para;</a></h2>
<p>EKS actively monitors the load on control plane instances and automatically scales them to ensure high performance. However, you should account for potential performance issues and limits within Kubernetes and quotas in AWS services when running large clusters.</p>
<ul>
<li>Clusters with more than 1000 services may experience network latency with using <code>kube-proxy</code> in <code>iptables</code> mode according to the <a href="https://www.projectcalico.org/comparing-kube-proxy-modes-iptables-or-ipvs/">tests performed by the ProjectCalico team</a>. The solution is to switch to <a href="https://medium.com/@jeremy.i.cowan/the-problem-with-kube-proxy-enabling-ipvs-on-eks-169ac22e237e">running <code>kube-proxy</code> in <code>ipvs</code> mode</a>.  </li>
<li>You may also experience <a href="https://docs.aws.amazon.com/AWSEC2/latest/APIReference/throttling.html">EC2 API request throttling</a> if the CNI needs to request IP addresses for Pods or if you need to create new EC2 instances frequently. You can reduce calls EC2 API by configuring the CNI to cache IP addresses. You can use larger EC2 instance types to reduce EC2 scaling events. </li>
</ul>
<h2 id="know-limits-and-service-quotas">Know limits and service quotas<a class="headerlink" href="#know-limits-and-service-quotas" title="Permanent link">&para;</a></h2>
<p>AWS sets service limits (an upper limit on the number of each resource your team can request) to protect you from accidentally over-provisioning resources. <a href="https://docs.aws.amazon.com/eks/latest/userguide/service-quotas.html">Amazon EKS Service Quotas</a> lists the service limits. There are two types of limits, soft limits, that can be changed using <a href="https://docs.aws.amazon.com/eks/latest/userguide/service-quotas.html">AWS Service Quotas</a>. Hard limits cannot be changed. You should consider these values when architecting your applications. Consider reviewing these service limits periodically and incorporate them during in your application design. </p>
<ul>
<li>Besides the limits from orchestration engines, there are limits in other AWS services, such as Elastic Load Balancing (ELB) and Amazon VPC, that may affect your application performance.</li>
<li>More about EC2 limits here: <a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-resource-limits.html">EC2 service limits</a>. </li>
<li>Each EC2 instance limits the number of packets that can be sent to the <a href="https://docs.aws.amazon.com/vpc/latest/userguide/vpc-dns.html#vpc-dns-limits">Amazon-provided DNS server</a> to a maximum of 1024 packets per second per network interface.</li>
</ul>
<h2 id="additional-resources">Additional Resources:<a class="headerlink" href="#additional-resources" title="Permanent link">&para;</a></h2>
<ul>
<li><a href="https://aws.amazon.com/blogs/containers/de-mystifying-cluster-networking-for-amazon-eks-worker-nodes/">De-mystifying cluster networking for Amazon EKS worker nodes</a></li>
<li><a href="https://docs.aws.amazon.com/eks/latest/userguide/cluster-endpoint.html">Amazon EKS cluster endpoint access control</a></li>
<li><a href="https://www.youtube.com/watch?v=7vxDWDD2YnM">AWS re:Invent 2019: Amazon EKS under the hood (CON421-R1)</a></li>
</ul>
                
              
              
                


              
            </article>
          </div>
        </div>
        
      </main>
      
        
<footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        <a href="../application/" class="md-footer__link md-footer__link--prev" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Applications
            </div>
          </div>
        </a>
      
      
        <a href="../dataplane/" class="md-footer__link md-footer__link--next" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Data Plane
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
        
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../../..", "features": ["tabs"], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}, "search": "../../../assets/javascripts/workers/search.fe42c31b.min.js", "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.4ea5477f.min.js"></script>
      
    
  </body>
</html>