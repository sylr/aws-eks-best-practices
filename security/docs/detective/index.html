
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-7.1.2">
    
    
      
        <title>Detective Controls - EKS Best Practices Guides</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.6f955dcd.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.ef6f36e2.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style>
      
    
    
    
    
      
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    <script>function __prefix(e){return new URL("../../..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#auditing-and-logging" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="EKS Best Practices Guides" class="md-header__button md-logo" aria-label="EKS Best Practices Guides" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            EKS Best Practices Guides
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Detective Controls
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        
<a href="https://github.com/aws/aws-eks-best-practices/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    aws/aws-eks-best-practices
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="EKS Best Practices Guides" class="md-nav__button md-logo" aria-label="EKS Best Practices Guides" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    EKS Best Practices Guides
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/aws/aws-eks-best-practices/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    aws/aws-eks-best-practices
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_1" type="checkbox" id="__nav_1" >
      
      <label class="md-nav__link" for="__nav_1">
        Guides
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Guides" data-md-level="1">
        <label class="md-nav__title" for="__nav_1">
          <span class="md-nav__icon md-icon"></span>
          Guides
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        Introduction
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" checked>
      
      <label class="md-nav__link" for="__nav_2">
        Security
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Security" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Security
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        Home
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../iam/" class="md-nav__link">
        Identity and Access Management
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../pods/" class="md-nav__link">
        Pod Security
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../multitenancy/" class="md-nav__link">
        Multi-tenancy
      </a>
    </li>
  

          
            
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Detective Controls
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Detective Controls
      </a>
      
        
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#recommendations" class="md-nav__link">
    Recommendations
  </a>
  
    <nav class="md-nav" aria-label="Recommendations">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#enable-audit-logs" class="md-nav__link">
    Enable audit logs
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#utilize-audit-metadata" class="md-nav__link">
    Utilize audit metadata
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-alarms-for-suspicious-events" class="md-nav__link">
    Create alarms for suspicious events
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#analyze-logs-with-log-insights" class="md-nav__link">
    Analyze logs with Log Insights
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#audit-your-cloudtrail-logs" class="md-nav__link">
    Audit your CloudTrail logs
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-cloudtrail-insights-to-unearth-suspicious-activity" class="md-nav__link">
    Use CloudTrail Insights to unearth suspicious activity
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#additional-resources" class="md-nav__link">
    Additional resources
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tooling" class="md-nav__link">
    Tooling
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../network/" class="md-nav__link">
        Network Security
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../data/" class="md-nav__link">
        Data Encryption and Secrets Management
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../runtime/" class="md-nav__link">
        Runtime Security
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../hosts/" class="md-nav__link">
        Infrastructure Security
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../compliance/" class="md-nav__link">
        Regulatory Compliance
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../incidents/" class="md-nav__link">
        Incident Response and Forensics
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../image/" class="md-nav__link">
        Image Security
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      <label class="md-nav__link" for="__nav_3">
        Cluster Autoscaling
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Cluster Autoscaling" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Cluster Autoscaling
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../cluster-autoscaling/cluster-autoscaling/" class="md-nav__link">
        Home
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      <label class="md-nav__link" for="__nav_4">
        Reliability
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Reliability" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Reliability
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../reliability/docs/" class="md-nav__link">
        Home
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../reliability/docs/application/" class="md-nav__link">
        Applications
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../reliability/docs/controlplane/" class="md-nav__link">
        Control Plane
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../reliability/docs/dataplane/" class="md-nav__link">
        Data Plane
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../reliability/docs/networkmanagement/" class="md-nav__link">
        Network
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#recommendations" class="md-nav__link">
    Recommendations
  </a>
  
    <nav class="md-nav" aria-label="Recommendations">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#enable-audit-logs" class="md-nav__link">
    Enable audit logs
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#utilize-audit-metadata" class="md-nav__link">
    Utilize audit metadata
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-alarms-for-suspicious-events" class="md-nav__link">
    Create alarms for suspicious events
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#analyze-logs-with-log-insights" class="md-nav__link">
    Analyze logs with Log Insights
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#audit-your-cloudtrail-logs" class="md-nav__link">
    Audit your CloudTrail logs
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-cloudtrail-insights-to-unearth-suspicious-activity" class="md-nav__link">
    Use CloudTrail Insights to unearth suspicious activity
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#additional-resources" class="md-nav__link">
    Additional resources
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tooling" class="md-nav__link">
    Tooling
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/aws/aws-eks-best-practices/edit/master/docs/security/docs/detective.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                <h1 id="auditing-and-logging">Auditing and logging<a class="headerlink" href="#auditing-and-logging" title="Permanent link">&para;</a></h1>
<p>Collecting and analyzing [audit] logs is useful for a variety of different reasons.  Logs can help with root cause analysis and attribution, i.e. ascribing a change to a particular user. When enough logs have been collected, they can be used to detect anomalous behaviors too. On EKS, the audit logs are sent to Amazon Cloudwatch Logs. The audit policy for EKS currently augments the reference <a href="https://github.com/kubernetes/kubernetes/blob/master/cluster/gce/gci/configure-helper.sh#L983-L1108">policy</a> in the helper script with the following policy: </p>
<div class="codehilite"><pre><span></span><code><span class="p p-Indicator">-</span> <span class="nt">level</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">RequestResponse</span>
    <span class="l l-Scalar l-Scalar-Plain">namespaces</span><span class="p p-Indicator">:</span> <span class="p p-Indicator">[</span><span class="s">&quot;kube-system&quot;</span><span class="p p-Indicator">]</span>
    <span class="nt">verbs</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="s">&quot;update&quot;</span><span class="p p-Indicator">,</span> <span class="s">&quot;patch&quot;</span><span class="p p-Indicator">,</span> <span class="s">&quot;delete&quot;</span><span class="p p-Indicator">]</span>
    <span class="nt">resources</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="nt">group</span><span class="p">:</span> <span class="s">&quot;&quot;</span> <span class="c1"># core</span>
        <span class="nt">resources</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="s">&quot;configmaps&quot;</span><span class="p p-Indicator">]</span>
        <span class="nt">resourceNames</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="s">&quot;aws-auth&quot;</span><span class="p p-Indicator">]</span>
    <span class="nt">omitStages</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="s">&quot;RequestReceived&quot;</span>
</code></pre></div>

<p>This logs changes to the <code>aws-auth</code> ConfigMap which is used to grant access to an EKS cluster. </p>
<h2 id="recommendations">Recommendations<a class="headerlink" href="#recommendations" title="Permanent link">&para;</a></h2>
<h3 id="enable-audit-logs">Enable audit logs<a class="headerlink" href="#enable-audit-logs" title="Permanent link">&para;</a></h3>
<p>The audit logs are part of the EKS managed Kubernetes control plane logs that are managed by EKS.  Instructions for enabling/disabling the control plane logs, which includes the logs for the Kubernetes API server, the controller manager, and the scheduler, along with the audit log, can be found here, <a href="https://docs.aws.amazon.com/eks/latest/userguide/control-plane-logs.html#enabling-control-plane-log-export">https://docs.aws.amazon.com/eks/latest/userguide/control-plane-logs.html#enabling-control-plane-log-export</a>. </p>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>When you enable control plane logging, you will incur <a href="https://aws.amazon.com/cloudwatch/pricing/">costs</a> for storing the logs in CloudWatch. This raises a broader issue about the ongoing cost of security. Ultimately you will have to weigh those costs against the cost of a security breach, e.g. financial loss, damage to your reputation, etc. You may find that you can adequately secure your environment by implementing only some of the recommendations in this guide. </p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The maximum size for a CWL entry is 256KB whereas the maximum Kubernetes API request size is 1.5MiB. This is important know because an attacker could theoretically obfuscate their activity by creating a request that is too large for CWL to handle. This can be done by padding the annotations field of a request with a large amount of junk data, which hides all data after the annotation.</p>
</div>
<h3 id="utilize-audit-metadata">Utilize audit metadata<a class="headerlink" href="#utilize-audit-metadata" title="Permanent link">&para;</a></h3>
<p>Kubernetes audit logs include two annotations that indicate whether or not a request was authorized <code>authorization.k8s.io/decision</code> and the reason for the decision <code>authorization.k8s.io/reason</code>.  Use these attributes to ascertain why a particular API call was allowed. </p>
<h3 id="create-alarms-for-suspicious-events">Create alarms for suspicious events<a class="headerlink" href="#create-alarms-for-suspicious-events" title="Permanent link">&para;</a></h3>
<p>Create an alarm to automatically alert you where there is an increase in 403 Forbidden and 401 Unauthorized responses, and then use attributes like <code>host</code>, <code>sourceIPs</code>, and <code>k8s_user.username</code> to find out where those requests are coming from.</p>
<h3 id="analyze-logs-with-log-insights">Analyze logs with Log Insights<a class="headerlink" href="#analyze-logs-with-log-insights" title="Permanent link">&para;</a></h3>
<p>Use CloudWatch Log Insights to monitor changes to RBAC objects, e.g. Roles, RoleBindings, ClusterRoles, and ClusterRoleBindings.  A few sample queries appear below: </p>
<p>Lists updates to the <code>aws-auth</code> ConfigMap:</p>
<div class="codehilite"><pre><span></span><code><span class="n">fields</span><span class="w"> </span><span class="nv">@timestamp</span><span class="p">,</span><span class="w"> </span><span class="nv">@message</span><span class="w"></span>
<span class="o">|</span><span class="w"> </span><span class="k">filter</span><span class="w"> </span><span class="nv">@logStream</span><span class="w"> </span><span class="ow">like</span><span class="w"> </span><span class="ss">&quot;kube-apiserver-audit&quot;</span><span class="w"></span>
<span class="o">|</span><span class="w"> </span><span class="k">filter</span><span class="w"> </span><span class="n">verb</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="o">[</span><span class="n">&quot;update&quot;, &quot;patch&quot;</span><span class="o">]</span><span class="w"></span>
<span class="o">|</span><span class="w"> </span><span class="k">filter</span><span class="w"> </span><span class="n">objectRef</span><span class="p">.</span><span class="n">resource</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">&quot;configmaps&quot;</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">objectRef</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">&quot;aws-auth&quot;</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">objectRef</span><span class="p">.</span><span class="n">namespace</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">&quot;kube-system&quot;</span><span class="w"></span>
<span class="o">|</span><span class="w"> </span><span class="n">sort</span><span class="w"> </span><span class="nv">@timestamp</span><span class="w"> </span><span class="k">desc</span><span class="w"></span>
</code></pre></div>

<p>Lists creation of new or changes to validation webhooks:</p>
<div class="codehilite"><pre><span></span><code><span class="n">fields</span><span class="w"> </span><span class="nv">@timestamp</span><span class="p">,</span><span class="w"> </span><span class="nv">@message</span><span class="w"></span>
<span class="o">|</span><span class="w"> </span><span class="k">filter</span><span class="w"> </span><span class="nv">@logStream</span><span class="w"> </span><span class="ow">like</span><span class="w"> </span><span class="ss">&quot;kube-apiserver-audit&quot;</span><span class="w"></span>
<span class="o">|</span><span class="w"> </span><span class="k">filter</span><span class="w"> </span><span class="n">verb</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="o">[</span><span class="n">&quot;create&quot;, &quot;update&quot;, &quot;patch&quot;</span><span class="o">]</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">responseStatus</span><span class="p">.</span><span class="n">code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">201</span><span class="w"></span>
<span class="o">|</span><span class="w"> </span><span class="k">filter</span><span class="w"> </span><span class="n">objectRef</span><span class="p">.</span><span class="n">resource</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">&quot;validatingwebhookconfigurations&quot;</span><span class="w"></span>
<span class="o">|</span><span class="w"> </span><span class="n">sort</span><span class="w"> </span><span class="nv">@timestamp</span><span class="w"> </span><span class="k">desc</span><span class="w"></span>
</code></pre></div>

<p>Lists create, update, delete operations to Roles:</p>
<div class="codehilite"><pre><span></span><code><span class="n">fields</span><span class="w"> </span><span class="nv">@timestamp</span><span class="p">,</span><span class="w"> </span><span class="nv">@message</span><span class="w"></span>
<span class="o">|</span><span class="w"> </span><span class="n">sort</span><span class="w"> </span><span class="nv">@timestamp</span><span class="w"> </span><span class="k">desc</span><span class="w"></span>
<span class="o">|</span><span class="w"> </span><span class="k">limit</span><span class="w"> </span><span class="mi">100</span><span class="w"></span>
<span class="o">|</span><span class="w"> </span><span class="k">filter</span><span class="w"> </span><span class="n">objectRef</span><span class="p">.</span><span class="n">resource</span><span class="o">=</span><span class="ss">&quot;roles&quot;</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">verb</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="o">[</span><span class="n">&quot;create&quot;, &quot;update&quot;, &quot;patch&quot;, &quot;delete&quot;</span><span class="o">]</span><span class="w"></span>
</code></pre></div>

<p>Lists create, update, delete operations to RoleBindings:</p>
<div class="codehilite"><pre><span></span><code><span class="n">fields</span><span class="w"> </span><span class="nv">@timestamp</span><span class="p">,</span><span class="w"> </span><span class="nv">@message</span><span class="w"></span>
<span class="o">|</span><span class="w"> </span><span class="n">sort</span><span class="w"> </span><span class="nv">@timestamp</span><span class="w"> </span><span class="k">desc</span><span class="w"></span>
<span class="o">|</span><span class="w"> </span><span class="k">limit</span><span class="w"> </span><span class="mi">100</span><span class="w"></span>
<span class="o">|</span><span class="w"> </span><span class="k">filter</span><span class="w"> </span><span class="n">objectRef</span><span class="p">.</span><span class="n">resource</span><span class="o">=</span><span class="ss">&quot;rolebindings&quot;</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">verb</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="o">[</span><span class="n">&quot;create&quot;, &quot;update&quot;, &quot;patch&quot;, &quot;delete&quot;</span><span class="o">]</span><span class="w"></span>
</code></pre></div>

<p>Lists create, update, delete operations to ClusterRoles:</p>
<div class="codehilite"><pre><span></span><code><span class="n">fields</span><span class="w"> </span><span class="nv">@timestamp</span><span class="p">,</span><span class="w"> </span><span class="nv">@message</span><span class="w"></span>
<span class="o">|</span><span class="w"> </span><span class="n">sort</span><span class="w"> </span><span class="nv">@timestamp</span><span class="w"> </span><span class="k">desc</span><span class="w"></span>
<span class="o">|</span><span class="w"> </span><span class="k">limit</span><span class="w"> </span><span class="mi">100</span><span class="w"></span>
<span class="o">|</span><span class="w"> </span><span class="k">filter</span><span class="w"> </span><span class="n">objectRef</span><span class="p">.</span><span class="n">resource</span><span class="o">=</span><span class="ss">&quot;clusterroles&quot;</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">verb</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="o">[</span><span class="n">&quot;create&quot;, &quot;update&quot;, &quot;patch&quot;, &quot;delete&quot;</span><span class="o">]</span><span class="w"></span>
</code></pre></div>

<p>Lists create, update, delete operations to ClusterRoleBindings:</p>
<div class="codehilite"><pre><span></span><code><span class="n">fields</span><span class="w"> </span><span class="nv">@timestamp</span><span class="p">,</span><span class="w"> </span><span class="nv">@message</span><span class="w"></span>
<span class="o">|</span><span class="w"> </span><span class="n">sort</span><span class="w"> </span><span class="nv">@timestamp</span><span class="w"> </span><span class="k">desc</span><span class="w"></span>
<span class="o">|</span><span class="w"> </span><span class="k">limit</span><span class="w"> </span><span class="mi">100</span><span class="w"></span>
<span class="o">|</span><span class="w"> </span><span class="k">filter</span><span class="w"> </span><span class="n">objectRef</span><span class="p">.</span><span class="n">resource</span><span class="o">=</span><span class="ss">&quot;clusterrolebindings&quot;</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">verb</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="o">[</span><span class="n">&quot;create&quot;, &quot;update&quot;, &quot;patch&quot;, &quot;delete&quot;</span><span class="o">]</span><span class="w"></span>
</code></pre></div>

<p>Plots unauthorized read operations against Secrets:</p>
<div class="codehilite"><pre><span></span><code><span class="n">fields</span><span class="w"> </span><span class="nv">@timestamp</span><span class="p">,</span><span class="w"> </span><span class="nv">@message</span><span class="w"></span>
<span class="o">|</span><span class="w"> </span><span class="n">sort</span><span class="w"> </span><span class="nv">@timestamp</span><span class="w"> </span><span class="k">desc</span><span class="w"></span>
<span class="o">|</span><span class="w"> </span><span class="k">limit</span><span class="w"> </span><span class="mi">100</span><span class="w"></span>
<span class="o">|</span><span class="w"> </span><span class="k">filter</span><span class="w"> </span><span class="n">objectRef</span><span class="p">.</span><span class="n">resource</span><span class="o">=</span><span class="ss">&quot;secrets&quot;</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">verb</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="o">[</span><span class="n">&quot;get&quot;, &quot;watch&quot;, &quot;list&quot;</span><span class="o">]</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">responseStatus</span><span class="p">.</span><span class="n">code</span><span class="o">=</span><span class="ss">&quot;401&quot;</span><span class="w"></span>
<span class="o">|</span><span class="w"> </span><span class="nf">count</span><span class="p">()</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">bin</span><span class="p">(</span><span class="mi">1</span><span class="n">m</span><span class="p">)</span><span class="w"></span>
</code></pre></div>

<p>List of failed anonymous requests:</p>
<div class="codehilite"><pre><span></span><code><span class="n">fields</span><span class="w"> </span><span class="nv">@timestamp</span><span class="p">,</span><span class="w"> </span><span class="nv">@message</span><span class="p">,</span><span class="w"> </span><span class="n">sourceIPs</span><span class="mf">.0</span><span class="w"></span>
<span class="o">|</span><span class="w"> </span><span class="n">sort</span><span class="w"> </span><span class="nv">@timestamp</span><span class="w"> </span><span class="k">desc</span><span class="w"></span>
<span class="o">|</span><span class="w"> </span><span class="k">limit</span><span class="w"> </span><span class="mi">100</span><span class="w"></span>
<span class="o">|</span><span class="w"> </span><span class="k">filter</span><span class="w"> </span><span class="k">user</span><span class="p">.</span><span class="n">username</span><span class="o">=</span><span class="ss">&quot;system:anonymous&quot;</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">responseStatus</span><span class="p">.</span><span class="n">code</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="o">[</span><span class="n">&quot;401&quot;, &quot;403&quot;</span><span class="o">]</span><span class="w"></span>
</code></pre></div>

<h3 id="audit-your-cloudtrail-logs">Audit your CloudTrail logs<a class="headerlink" href="#audit-your-cloudtrail-logs" title="Permanent link">&para;</a></h3>
<p>AWS APIs called by pods that are utilizing IAM Roles for Service Accounts (IRSA) are automatically logged to CloudTrail along with the name of the service account. If the name of a service account that wasn't explicitly authorized to call an API appears in the log, it may be an indication that the IAM role's trust policy was misconfigured. Generally speaking, Cloudtrail is a great way to ascribe AWS API calls to specific IAM principals. </p>
<h3 id="use-cloudtrail-insights-to-unearth-suspicious-activity">Use CloudTrail Insights to unearth suspicious activity<a class="headerlink" href="#use-cloudtrail-insights-to-unearth-suspicious-activity" title="Permanent link">&para;</a></h3>
<p>CloudTrail insights automaticatlly analyzes write management events from CloudTrail trails and alerts you of unusual activity. This can help you identify when there's an increase in call volume on write APIs in your AWS account, including from pods that use IRSA to assume an IAM role. See <a href="https://aws.amazon.com/blogs/aws/announcing-cloudtrail-insights-identify-and-respond-to-unusual-api-activity/">Announcing CloudTrail Insights: Identify and Response to Unusual API Activity</a> for further information.</p>
<h3 id="additional-resources">Additional resources<a class="headerlink" href="#additional-resources" title="Permanent link">&para;</a></h3>
<p>As the volume of logs increases, parsing and filtering them with Log Insights or another log analysis tool may become ineffective.  As an alternative, you might want to consider running <a href="https://github.com/falcosecurity/falco">Sysdig Falco</a> and <a href="https://github.com/sysdiglabs/ekscloudwatch">ekscloudwatch</a>. Falco analyzes audit logs and flags anomalies or abuse over an extended period of time. The ekscloudwatch project forwards audit log events from CloudWatch to Falco for analysis. Falco provides a set of <a href="https://github.com/falcosecurity/falco/blob/master/rules/k8s_audit_rules.yaml">default audit rules</a> along with the ability to add your own. </p>
<p>Yet another option might be to store the audit logs in S3 and use the SageMaker <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/randomcutforest.html">Random Cut Forest</a> algorithm to anomalous behaviors that warrant further investigation.</p>
<h2 id="tooling">Tooling<a class="headerlink" href="#tooling" title="Permanent link">&para;</a></h2>
<p>The following commercial and open source projects can be used to assess your cluster's alignment with established best practices:</p>
<ul>
<li><a href="https://github.com/Shopify/kubeaudit">kubeaudit</a></li>
<li><a href="https://github.com/darkbitio/mkit">MKIT</a></li>
<li><a href="https://github.com/octarinesec/kube-scan">kube-scan</a> Assigns a risk score to the workloads running in your cluster in accordance with the Kubernetes Common Configuration Scoring System framework</li>
<li><a href="https://github.com/genuinetools/amicontained">amicontained</a> Reveals which Capabilities are allowed and syscalls that are blocked by the container runtime</li>
<li><a href="https://kubesec.io/">kubesec.io</a></li>
<li><a href="https://github.com/FairwindsOps/polaris">polaris</a></li>
<li><a href="https://github.com/aquasecurity/starboard">Starboard</a></li>
<li><a href="https://www.alcide.io/kaudit-K8s-forensics/">kAudit</a></li>
<li><a href="https://support.snyk.io/hc/en-us/articles/360003916138-Kubernetes-integration-overview">Snyk</a></li>
</ul>
                
              
              
                


              
            </article>
          </div>
        </div>
        
      </main>
      
        
<footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        <a href="../multitenancy/" class="md-footer__link md-footer__link--prev" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Multi-tenancy
            </div>
          </div>
        </a>
      
      
        <a href="../network/" class="md-footer__link md-footer__link--next" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Network Security
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
        
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../../..", "features": ["tabs"], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}, "search": "../../../assets/javascripts/workers/search.fe42c31b.min.js", "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.4ea5477f.min.js"></script>
      
    
  </body>
</html>